---
title: "Bayesian Linear Regression"
output: statsr:::statswithr_lab

references:
- id: Wooldridge2000
  title:  Introductory Econometrics- A Modern Approach
  author:
  - family: Wooldridge
    given: Jeffrey
  URL: 'http://fmwww.bc.edu/ec-p/data/wooldridge/wage2.dta'
  publisher: South-Western College Publishing
  type: book
  issued:
    year: 2000
---

<div class="instructions">
Complete all **Exercises**, and submit answers to **Questions** on the Coursera 
platform.
</div>

## Modeling Wages 

In the field of labor economics, the study of income and wages provides insight about topics ranging from gender discrimination to the benefits of higher education.  In this lab, we will analyze cross-sectional wage data in order to practice using Bayesian selection methods such as BIC and Bayesian Model Averaging to construct parsimonious predictive models.

## Getting Started

### Load packages

In this lab we will explore the data using the `dplyr` package and visualize it using the `ggplot2` package for data visualization. We also may need the `MASS` package to implement stepwise linear regression in one of the exercises.  The data can be found in the companion package for this course, `statsr`. 

Let us load the packages.

```{r load-packages, message=FALSE}
library(statsr)
library(MASS)
library(dplyr)
library(ggplot2)
library(BAS)
```

We will be using the `bas.lm` function from the `BAS` package later in the lab to implement Bayesian Model Averaging.  Please make sure that the version of `BAS` is 1.3.0 or greater.

### The data

The data we will be using in this lab were gathered as a random sample of 935 respondents throughout the United States. This data set was released as part of the series *Instructional Stata Datasets for Econometrics* by the Boston College Department of Economics [@Wooldridge2000].

Let us load the data:

```{r load-data, message=FALSE}
data(wage)
```

variable         | description
---------------- | -----------
`wage`           | weekly earnings (dollars)
`hours`          | average hours worked per week
`IQ`             | IQ score
`kww`            | knowledge of world work score
`educ`           | number of years of education
`exper`          | years of work experience
`tenure`         | years with current employer
`age`            | age in years
`married`        | =1 if married
`black`          | =1 if black
`south`          | =1 if live in south
`urban`          | =1 if live in a Standard Metropolitan Statistical Area
`sibs`           | number of siblings
`brthord`        | birth order
`meduc`          | mother's education (years)
`feduc`          | father's education (years)
`lwage`          | natural log of `wage`


<div class="question">
Is this an observational study or an experiment? You may refer to http://study.com/academy/lesson/experiments-vs-observational-studies.html for the definitions of the two.

* Observational study
* Experiment
</div>

## Exploring the data

For a new data set, a good place to start is the standard exploratory data analysis. We will begin with the `wage` variable since it will be the response variable in our models. We may use a histogram or to summarize the variable `wage` to get some insights about the distribution of `wage`.

<div class="question">
Which of the following statements is **false** about the distribution of `wage`? 

* The median of the distribution is 905.
* 25\% of respondents make at least 1160 dollars per week.
* 7 of the respondents make strictly less than 300 dollars per week
* `wage` is right-skewed, meaning that more respondents fall below the mean wage than above it.
</div>

```{r Q2-wage-dist}
# Type your code for Question 2 here.
```

Since `wage` is our response variable, we would like to explore the relationship between `wage` and other variables as predictors.

<div class="exercise">
Excluding `wage` and `lwage`, select two other variables that you think might be good predictors of `wage`.  Visualize their relationships with `wage` using appropriate plots.
</div>

```{r two-vars-eda}
# Type your code for Exercise 1 here.
```

## Simple linear regression

One possible, simplistic, explanation for the variation in wages that we see in the data is that smarter people make more money. The plot below visualizes a scatterplot between weekly wage and IQ score.

```{r scatter-score-bty_avg}
ggplot(data = wage, aes(x = iq, y = wage)) +
  geom_point()
```

This plot is rather noisy.  While there may be a slight positive linear relationship between IQ score and wage, IQ is at best a crude predictor of wages.  We can quantify this by fitting a simple linear regression as follows:


```{r wage-iq-model}
# Use `lm` function to conduct usual linear regression
m_wage_iq = lm(wage ~ iq, data = wage)

# Extract the regression coefficients from the model we just built
m_wage_iq$coefficients

# Extract the information of the residual standard error from the summary of the model
summary(m_wage_iq)$sigma
```


Recall from the lectures that under the model

$$\text{wage}_i = \alpha + \beta \cdot \text{iq}_i + \epsilon_i$$

if $\epsilon_i \sim N(0, \sigma^2)$ and the reference prior $\pi(\alpha, \beta, \sigma^2) \propto 1/\sigma^2$ is used, then the Bayesian posterior means and standard deviations will be equal to the frequentist estimates and standard errors respectively.  

The Bayesian model specification assumes that the errors are normally distributed with a constant variance. As with the frequentist approach we check this assumption by examining the distribution of the residuals for the model.  If the residuals are highly non-normal or skewed, the assumption is violated and any subsequent inference is not valid.


<div class="question">
Examine the residuals from the model `m_wage_iq` (you may find the residuals through `m_wage_iq$residuals`).  Is the assumption of normally distributed errors valid?

* Yes, since the distribution of the dependent variable (`wage`) is roughly normally distributed.
* Yes, since the distribution of the residuals of the model looks approximately normal.
* No, since the distribution of the residuals of the model is left-skewed.
* No, since the distribution of the residuals of the model is right-skewed. 
</div>

```{r Q3-resid}
# Type your code for Question 3 here.
```


<div class="exercise">
Refit the model by using `educ` (education) as the independent variable. Does your answer to the previous exercise change?
</div>

```{r educ-resid}
# Type your code for Exercise 2 here.
```

## Variable transformation

One way to accommodate the right-skewness in the data is to (natural) log-transform the dependent variable. Note that this is only possible if the variable is strictly positive, since the log of negative value is not defined and $\log(0) = -\infty$.  Let us try to fit a linear model with log-wage (`lwage`) as the dependent variable.  Question 4 will be based on this log transformed model.

```{r lwage-iq-model}
m_lwage_iq = lm(lwage ~ iq, data = wage)
```

<div class="exercise">
Examine the residuals of this model. Is the assumption of normally distributed residuals reasonable?
</div>

```{r log-resid}
# Type your code for Exercise 3 here.
```

Recall that the posterior distribution of $\alpha$ and $\beta$ given $\sigma^2$, $\pi^\ast (\alpha, \beta ~ | ~ \sigma^2)$, is normal, but marginally, $\pi^\ast (\alpha~ | ~ \sigma^2)$ and $\pi^\ast (\beta~|~\sigma^2)$ follow $t$ distribution with $n-p-1$ degrees of freedom.  In this case, $p=1$, since IQ is the only predictor of log-wage included in our model. Therefore both $\alpha$ and $\beta$ will have posterior distributions that follow $t$-distributions with 933 degrees of freedom. With such a large degree of freedom, we may assume these distributions are approximately normal.

<div class="question">
Under the reference prior $\pi(\alpha, \beta, \sigma^2) \propto 1/\sigma^2$, give a 95\% posterior credible interval for $\beta$, the coefficient of IQ. Hint: you may leverage the fact that the posterior distribution of $\beta$ is a $t$-distribution close to the Normal distribution. Or you may use the $t$-distribution that $\beta$ follows and the fact that the $t$-distribution is symmetric about its center.

* (0.00793, 0.00967)
* (0.00709, 0.01050)
* (0.00663, 0.01098)
* (0.00010, 0.01750) 
</div>

```{r Q4-cred-interval}
# Type your code for Question 4 here.
```


<div class="exercise">
The coefficient of IQ is very small, which is expected since a one point increase in IQ score can hardly be expected to have a high multiplicative effect on wage.  One way to make the coefficient more interpretable is to standardize IQ before putting it into the model. From this new model, an increase in IQ of 1 standard deviation (15 points) is estimated to increase wage by what percentage?
</div>

```{r z-iq}
# Type your code for Exercise 4 here.
```

## Multiple linear regression

It is evident that wage can be explained by many predictors, such as experience, education, IQ, and so on.  We can include all relevant covariates in a regression model in an attempt to explain as much wage variation as possible.   


```{r full-lwage-model}
m_lwage_full = lm(lwage ~ . - wage, data = wage)
```

The use of `. - wage` in the `lm` fucntion tells R to include all covariates in the model except the `wage` variable from the data set.

However, running this full model has a cost: we will remove observations from our data if some measurements in the variables (e.g. birth order, mother's education, and father's education) are missing. By default, the `lm` function does a complete-case analysis. So it removes any observations with a missing (`NA`) value in one or more of the predictor variables. 

Because of these missing values we must make an addition assumption in order for our inferences to be valid. This exclusion of rows with missing values requires that in the data there is no systematic reason for the values to be missing. In other words, our data must be missing at random. For example, if all first-born children did not report their birth order, the data would not be missing at random.  Without any additional information we will assume this is reasonable and use the 663 complete observations (as opposed to the original 935) to fit the model.  Both Bayesian and frequentist methods exist to handle data sets with missing data, but they are beyond the scope of this course.  

<div class="question">
From the model, all else begin equal, who would you expect to make more: a married black man or a single non-black man?

* The married black man
* The single non-black man
</div>

```{r Q5}
# Type your code for Question 5 here.
```

As you can see from a quick summary of the full linear model, many coefficients of independent variables are not statistically significant. In previous labs within this specialization, you selected variables based on the values of Adjusted $R^2$. This module introduced the Bayesian Information Criterion (BIC), which is a metric that can be used for model selection. BIC is based on model fit, while simultaneously penalizing the number of parameters in proportion to the sample size.  We can calculate the BIC of the full linear model using the command below:

```{r}
BIC(m_lwage_full)
```

We can compare the BIC of the full model with that of a reduced model.  Let us try to remove birth order from the model. To ensure that the observations remain the same, the data set can be specified as `na.omit(wage)`, which includes only the observations with no missing values in any variables in the data set.

```{r}
m_lwage_nobrthord = lm(lwage ~ . -wage -brthord, data = na.omit(wage))
BIC(m_lwage_nobrthord)
```

As you can see, removing birth order from the regression reduces BIC, which we seek to minimize by model selection.

<div class="question">
Elimination of which variable from the full model yielded the lowest BIC?

* `brthord`
* `sibs`
* `feduc`
* `meduc`
</div>

```{r Q6-BIC}
# Type your code for Question 6 here.
```

<div class="exercise">
R has a function `stepAIC` that will work backwards through the model space, removing variables until the AIC score can be no longer lowered.  It takes all inputs in the full model, and a penalty parameter $k$. The default setting is $k=2$ for the AIC score. Find the best model according to BIC (in which case $k = \log(n)$ where $n$ is the number of observations).  Remember to use `na.omit(wage)` as your data set. You may type `?stepAIC` in the RStudio Console to get the use and examples of the function `stepAIC`.  
</div>

```{r step}
# Type your code for Exercise 5 here.
```

## Bayesian model averaging

Often, several models are equally plausible and choosing only one ignores the inherent uncertainty involved in choosing the variables to include in the model.  A way to get around this problem is to implement Bayesian model averaging (BMA), in which multiple models are averaged to obtain posteriors of coefficients and predictions from new data. Dr. Merlise Clyde is the primary author of the R package `BAS`, which implements BMA.  We can use this for either implementing BMA or selecting models.

We start by applying BMA to the wage data.

```{r bas-wage}
# Exclude observations with missing values in the data set
wage_no_na = na.omit(wage)

# Fit the model using Bayesian linear regression, `bas.lm` function in the `BAS` package
bma_lwage = bas.lm(lwage ~ . -wage, data = wage_no_na,
                   prior = "BIC", 
                   modelprior = uniform())

# Print out the marginal posterior inclusion probabilities for each variable                
bma_lwage

# The top 5 most probably models
summary(bma_lwage)
```

Printing the model object and the summary command gives us both the posterior model inclusion probability for each variable and the most probable models.  For example, the posterior probability that `hours` is included in the model is 0.855.  Further, the most likely model, which has posterior probability of 0.0455, includes an intercept, hours worked, IQ, education, tenure, age, marital status, urban living status, and mother's education.  While a posterior probability of 0.0455 sounds small, it is much larger than the uniform prior probability assigned to it, since there are $2^{16}$ possible models. 

It is also possible to visualize the posterior distribution of the coefficients under the model averaging approach.  We graph the posterior distribution of the coefficients of `iq` and `sibs` below.  Note that the subset command dictates which variable is plotted.

```{r vis-BMA}
par(mfrow = c(1,2))
# Obtain the coefficients from the model `bma_lwage`
coef_lwage = coefficients(bma_lwage)

# `iq` is the 3rd variable, while `sibs` is the 13th variable in the data set
plot(coef_lwage, subset = c(3,13), ask=FALSE)
```

We can also provide 95% credible intervals for these coefficients:

```{r conf-BMA}
confint(coef_lwage)
```

For Questions 7-8, we'll use a reduced data set which excludes number of siblings, birth order, and parental education.

```{r rem-vars-wage}
wage_red = wage %>%
  select(-sibs, -brthord, -meduc, -feduc)
```

<div class="question">
Based on this reduced data set, according to Bayesian model averaging, which of the following variables has the lowest marginal posterior inclusion probability?

* `kww`
* `black`
* `south`
* `age`
</div>

```{r Q7-reduced-BMA}
# Type your code for Question 7 here.
```


<div class="question">
True or False: The naive model with all variables included has posterior probability greater than 0.5. (Use a Zellner-Siow null prior for the coefficients and a $\text{Beta}(1,1)$ prior for the models)

* True
* False
</div>

```{r Q8}
# Type your code for Question 8 here.
```


<div class="exercise">
Graph the posterior distribution of the coefficient of `age`, using the data set `wage_red`.
</div>

```{r graph}
par(mfrow = c(1,1))
# Type your code for Exercise 6 here.
```

## Prediction with BAS

Similar to last week's lab, we will be using Bayesian predictive distribution for predictions and interpretation of predictions. Simulation is used in `BAS` to construct predictive intervals with Bayesian Model averaging, while exact inference is often possible with predictive intervals under model selection.

Returning to the wage data set, let us find the predictive values under the *Best Predictive Model* (`BPM`), the one which has predictions closest to BMA and corresponding posterior standard deviations.

```{r bma_predict, cache=TRUE}
BPM_pred_lwage =  predict(bma_lwage, estimator="BPM", se.fit=TRUE)
bma_lwage$namesx[BPM_pred_lwage$bestmodel+1]
```

We can compare this to the Highest probability model that we found earlier and the *Median Probability Model* (`MPM`)

```{r MPM}
MPM_pred_lwage =  predict(bma_lwage, estimator="MPM")
bma_lwage$namesx[MPM_pred_lwage$bestmodel+1]
```

The `MPM` includes `exper` in addition to all of the variables as the *Highest Probability Model* (`HPM`), while the `BPM` includes  `kwh` in addition to all of the variables in the `MPM`. 

<div class="question">
Using the reduced data, what covariates are included in **all** of the best predictive model, the median probability model and the highest posterior probability model?
</div>

* `kww`, `married`, `urban`
* `married`, `age`, `black`
* `black`, `south`, `married`
* `meduc`, `urban`, `married`

```{r Q9}
# Type your code for Question 9 here.
```

Let us turn to examine what characteristics lead to the highest wages in the `BPM` model.

```{r opt_wage}
# Find the index of observation with the largest fitted value
opt = which.max(BPM_pred_lwage$fit)

# Extract the row with this observation and get the tranpose of this row (for easy visualization) 
t(wage_no_na[opt, ])
```

A 95% credible interval for predicting log wages can be obtained by

```{r ci}
ci_lwage = confint(BPM_pred_lwage, parm="pred")
ci_lwage[opt,]
```

To translate this back to `wage` (recall that we regress `lwage`), we may exponentiate the interval to obtain a 95% prediction interval for the wages of an individual with covariates at the levels of the individual specified by `opt`.

```{r ci_wage}
exp(ci_lwage[opt,])
```

If we were to use BMA, the interval would be 

```{r}
BMA_pred_lwage =  predict(bma_lwage, estimator="BMA", se.fit=TRUE)
ci_bma_lwage = confint(BMA_pred_lwage, estimator="BMA")
opt_bma = which.max(BMA_pred_lwage$fit)
exp(ci_bma_lwage[opt_bma,])
```

<div class="question">
Using the reduced data, construct a 95% prediction interval for the individual who is predicted to have the highest predicted wages under `BPM`.
</div>

* [414.3266, 1717.8644]
* [782.0124, 2950.5898]
* [782.0124, 3154.0718]
* [706.4599, 2950.5898]

```{r Q10-cred-interval}
# Type your code for Question 10 here.
```

## References

